<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Tracking - PISA Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Your existing CSS styles remain unchanged */
    :root {
      --primary-color: #2e7d32;
      --primary-light: #e8f5e9;
      --secondary-color: #ff9800;
      --text-dark: #333;
      --text-light: #666;
      --border-color: #e0e0e0;
      --success-color: #4caf50;
      --warning-color: #ffc107;
      --error-color: #f44336;
      --info-color: #2196F3;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: var(--text-dark);
      line-height: 1.6;
    }

    header {
      background: var(--primary-color);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .search-bar {
      padding: 1.5rem;
      display: flex;
      justify-content: center;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .search-bar input {
      padding: 12px 15px;
      width: 300px;
      border: 1px solid var(--border-color);
      border-radius: 6px 0 0 6px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .search-bar input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
    }

    .search-bar button {
      padding: 12px 25px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .search-bar button:hover {
      background: #1b5e20;
      transform: translateY(-1px);
    }

    .card {
      background: white;
      margin: 1.5rem auto;
      padding: 1.5rem;
      border-radius: 10px;
      width: 90%;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }

    .card h3 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.3rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h3 i {
      font-size: 1.2rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .info-item {
      margin-bottom: 5px;
    }

    .tag {
      font-weight: 500;
      color: var(--text-light);
      display: inline-block;
      min-width: 80px;
    }

    .value {
      font-weight: 400;
      color: var(--text-dark);
    }

    .product-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }

    .product-item {
      text-align: center;
      transition: transform 0.3s;
    }

    .product-item:hover {
      transform: scale(1.03);
    }

    .product-img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 5px;
      background: white;
      margin-bottom: 8px;
    }

    .product-name {
      font-size: 0.9rem;
      color: var(--text-dark);
      margin: 5px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-container {
      margin: 20px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      border: 1px solid #eee;
    }

    .current-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      color: #333;
    }

    .current-status i {
      color: var(--primary-color);
    }

    .status-tracker {
      position: relative;
    }

    .status-progress-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      margin: 25px 12px 35px;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .status-milestones {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .milestone {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .milestone-marker {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .milestone.active .milestone-marker {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
    }

    .milestone.completed .milestone-marker {
      background: var(--primary-color);
      color: white;
    }

    .milestone-label {
      font-size: 12px;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      text-align: center;
      position: absolute;
      top: 40px;
      white-space: nowrap;
    }

    .milestone.active .milestone-label,
    .milestone.completed .milestone-label {
      color: var(--primary-color);
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--border-color);
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .timestamp {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .payment-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      background: var(--primary-light);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .payment-item {
      display: flex;
      justify-content: space-between;
    }

    .payment-label {
      font-weight: 500;
      color: var(--text-dark);
    }

    .payment-value {
      font-weight: 600;
    }

    .total-amount {
      font-size: 1.1rem;
      color: var(--primary-color);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      justify-content: center;
    }

    .cancel-btn {
      background-color: var(--error-color);
      color: white;
    }

    .cancel-btn:hover {
      background-color: #d32f2f;
    }

    .cancel-btn:disabled {
      background-color: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
    }

    .return-btn {
      background-color: var(--info-color);
      color: white;
    }

    .return-btn:hover {
      background-color: #1976d2;
    }

    .return-btn:disabled {
      background-color: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
      display: none;
    }

    .cancel-return-btn {
      background-color: var(--warning-color);
      color: white;
    }

    .cancel-return-btn:hover {
      background-color: #ff8f00;
    }

    .cancel-return-btn:disabled {
      background-color: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
    }

    .delivery-date {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      font-size: 1.3rem;
      font-weight: 500;
      margin-bottom: 15px;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-body {
      margin-bottom: 20px;
      color: var(--text-light);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .modal-btn-cancel {
      background-color: #e0e0e0;
      color: var(--text-dark);
    }

    .modal-btn-cancel:hover {
      background-color: #bdbdbd;
    }

    .modal-btn-confirm {
      background-color: var(--error-color);
      color: white;
      border: none;
    }

    .modal-btn-confirm:hover {
      background-color: #d32f2f;
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: var(--success-color);
      color: white;
      padding: 16px 24px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 350px;
    }

    .notification.active {
      transform: translateX(0);
    }

    .notification.error {
      background-color: var(--error-color);
    }

    .notification.warning {
      background-color: var(--warning-color);
    }

    .notification.info {
      background-color: var(--info-color);
    }

    .notification-icon {
      font-size: 20px;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .notification-message {
      font-size: 14px;
      opacity: 0.9;
    }

    .notification-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .notification-close:hover {
      opacity: 1;
    }

    .circular-tracker {
      display: none;
      width: 200px;
      height: 200px;
      margin: 20px auto;
      position: relative;
      border-radius: 50%;
      background: conic-gradient(var(--primary-color) 0%, #e0e0e0 0%);
      transition: background 1s ease;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      touch-action: none;
      transform-style: preserve-3d;
    }

    .circular-tracker::before {
      content: '';
      position: absolute;
      width: 180px;
      height: 180px;
      background: white;
      border-radius: 50%;
      top: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .circular-tracker-inner {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
      text-align: center;
      transform: translateZ(0);
    }

    .circular-tracker-status {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 5px;
      font-size: 16px;
    }

    .circular-tracker-hint {
      font-size: 12px;
      color: var(--text-light);
      padding: 0 20px;
    }

    /* Beauty tip popup */
    .beauty-tip {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 90%;
      z-index: 1000;
      display: none;
    }

    .beauty-tip.show {
      display: block;
      animation: fadeInUp 0.5s;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .beauty-tip-content {
      font-size: 14px;
      color: var(--text-dark);
    }

    .beauty-tip-close {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Return timer styles */
    .return-timer {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 8px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .return-timer.expired {
      color: var(--error-color);
    }

    /* PISA Code expiration message */
    .pisa-expired-message {
      background: #fff8e1;
      border-left: 4px solid var(--warning-color);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pisa-expired-message h4 {
      margin: 0;
      color: var(--warning-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .whatsapp-btn {
      background-color: #25D366;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
    }

    .whatsapp-btn:hover {
      background-color: #128C7E;
    }

    /* Cashback message styles */
    .cashback-message {
      background-color: #e8f5e9;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      text-align: center;
      display: none;
    }

    .cashback-message p {
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .info-grid, .payment-grid {
        grid-template-columns: 1fr;
      }
      
      .search-bar {
        flex-direction: column;
        align-items: center;
      }
      
      .search-bar input {
        width: 100%;
        margin-bottom: 10px;
        border-radius: 6px;
      }
      
      .search-bar button {
        width: 100%;
        margin-left: 0;
        border-radius: 6px;
      }

      .status-milestones {
        flex-wrap: wrap;
        gap: 20px;
      }
    
      .milestone {
        flex: 0 0 calc(33% - 20px);
      }
    
      .milestone-label {
        position: static;
        margin-top: 5px;
      }

      .modal-content {
        width: 95%;
        padding: 15px;
      }

      .modal-footer {
        flex-direction: column;
      }

      .modal-btn {
        width: 100%;
      }

      .notification {
        left: 20px;
        right: 20px;
        max-width: none;
        transform: translateY(-150%);
      }
      
      .notification.active {
        transform: translateY(0);
      }

      /* Show circular tracker on mobile */
      .status-tracker {
        display: none;
      }

      .circular-tracker {
        display: block;
      }

      .action-btn {
        width: 100%;
        text-align: center;
        padding: 10px;
      }

      .action-buttons {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 1rem;
        width: 95%;
      }

      .payment-item {
        flex-direction: column;
        gap: 5px;
      }

      .circular-tracker {
        width: 160px;
        height: 160px;
      }

      .circular-tracker::before {
        width: 140px;
        height: 140px;
      }

      .header-content {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <i class="fas fa-shopping-bag"></i> Hey Buddy, Enter your Pisa Code Here
    </div>
  </header>

  <div class="container">
    <div id="pisaExpiredMessage" class="pisa-expired-message" style="display: none;">
      <h4><i class="fas fa-exclamation-triangle"></i> Your PISACODE expired, please Enter Now</h4>
      <p>If you forget please text us</p>
      <button class="whatsapp-btn" onclick="openWhatsApp()">
        <i class="fab fa-whatsapp"></i> Contact via WhatsApp
      </button>
    </div>

    <div class="search-bar">
      <input type="text" id="pisaInput" placeholder="Enter your PISA Code..." />
      <button onclick="searchPisa()">
        <i class="fas fa-search"></i> Track Order
      </button>
    </div>

    <div id="results">
      <div class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No orders found</h3>
        <p>Enter your PISA code to view your order history and tracking information</p>
      </div>
    </div>
  </div>


  
  <div class="modal-overlay" id="confirmationModal">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fas fa-exclamation-circle"></i>
        <span>Confirm Cancellation</span>
      </div>
      <div class="modal-body">
        Are you sure you want to cancel this order? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">
          <i class="fas fa-times"></i> No, Keep It
        </button>
        <button class="modal-btn modal-btn-confirm" onclick="confirmCancellation()">
          <i class="fas fa-check"></i> Yes, Cancel Order
        </button>
      </div>
    </div>
  </div>

  
  <div class="modal-overlay" id="cancelReturnModal">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Confirm Return Cancellation</span>
      </div>
      <div class="modal-body">
        You can't raise return request after this and you must take the order & pay for it. Otherwise legal action will be taken. Still you want to proceed?
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeCancelReturnModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="modal-btn modal-btn-confirm" onclick="confirmCancelReturn()">
          <i class="fas fa-check"></i> Proceed
        </button>
      </div>
    </div>
  </div>


  <div class="notification" id="appNotification">
    <i class="fas fa-check-circle notification-icon"></i>
    <div class="notification-content">
      <div class="notification-title">Success</div>
      <div class="notification-message">Operation completed successfully</div>
    </div>
    <button class="notification-close" onclick="hideNotification()">
      <i class="fas fa-times"></i>
    </button>
  </div>


  <div class="beauty-tip" id="beautyTip">
    <button class="beauty-tip-close" onclick="hideBeautyTip()">
      <i class="fas fa-times"></i>
    </button>
    <div class="beauty-tip-content" id="beautyTipContent">
      Loading beauty tip...
    </div>
  </div>

  <script>
    const baseURL = "https://pisa-backend.onrender.com";
    let currentCartIdToCancel = null;
    let activeTracker = null;
    let animationFrameId = null;
    let spinStartTime = 0;
    const SPIN_DURATION = 3000; // 3 seconds spin duration
    let isSpinning = false;
    let returnTimers = {}; // Store timers for return button countdowns
    const RETURN_PERIOD_MS = 12 * 60 * 60 * 1000; // 12 hours in milliseconds
    const CANCEL_RETURN_PERIOD_MS = 6 * 60 * 60 * 1000; // 6 hours in milliseconds

    // Function to open WhatsApp
    function openWhatsApp() {
      window.open(`https://wa.me/918185843878`, '_blank');
    }

    // Function to open WhatsApp with specific message
    function openWhatsAppWithMessage(message) {
      window.open(`https://wa.me/918185843878?text=${encodeURIComponent(message)}`, '_blank');
    }

    // Save PISACODE to localStorage with timestamp
    function savePisaCode(pisaCode) {
      const pisaData = {
        code: pisaCode,
        timestamp: new Date().getTime()
      };
      localStorage.setItem('pisaCode', JSON.stringify(pisaData));
    }

    // Get PISACODE from localStorage and check if it's expired (7 days)
    function getStoredPisaCode() {
      const storedData = localStorage.getItem('pisaCode');
      if (!storedData) return null;
      
      try {
        const pisaData = JSON.parse(storedData);
        const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
        const currentTime = new Date().getTime();
        
        if (currentTime - pisaData.timestamp > sevenDaysMs) {
          // Show expiration message
          document.getElementById('pisaExpiredMessage').style.display = 'block';
          return null;
        }
        
        return pisaData.code;
      } catch (e) {
        console.error('Error parsing stored PISA code:', e);
        return null;
      }
    }

    // Load saved PISA code on page load
    function loadSavedPisaCode() {
      const savedPisa = getStoredPisaCode();
      if (savedPisa) {
        document.getElementById('pisaInput').value = savedPisa;
        // Auto-search if we have a valid code
        searchPisa();
      }
    }

    // Modal functions
    function showModal(cartId) {
      currentCartIdToCancel = cartId;
      document.getElementById('confirmationModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('confirmationModal').classList.remove('active');
      document.body.style.overflow = '';
      currentCartIdToCancel = null;
    }

    function showCancelReturnModal(cartId) {
      currentCartIdToCancel = cartId;
      document.getElementById('cancelReturnModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCancelReturnModal() {
      document.getElementById('cancelReturnModal').classList.remove('active');
      document.body.style.overflow = '';
      currentCartIdToCancel = null;
    }

    function confirmCancellation() {
      if (currentCartIdToCancel) {
        updateOrderStatus(currentCartIdToCancel, 'cancelled');
      }
      closeModal();
    }

    function confirmCancelReturn() {
      if (currentCartIdToCancel) {
        // Update status to cancelled return
        updateOrderStatus(currentCartIdToCancel, 'cancelled return');
        
        // Show cashback message
        const cardElement = document.querySelector(`[data-cart="${currentCartIdToCancel}"]`);
        if (cardElement) {
          const cashbackMessage = cardElement.querySelector('.cashback-message');
          if (cashbackMessage) {
            cashbackMessage.style.display = 'block';
          }
        }
        
        // Send notification to dashboard
        const pisaCode = document.getElementById('pisaInput').value.trim();
        sendCancelReturnNotification(currentCartIdToCancel, pisaCode);
      }
      closeCancelReturnModal();
    }

    // Send notification to dashboard about cancelled return
    function sendCancelReturnNotification(cartId, pisaCode) {
      // In a real implementation, this would send a request to the server
      // For now, we'll just log it
      console.log(`Return cancelled for cart ${cartId} with PISACODE: ${pisaCode}`);
      
      // You would typically make a fetch request here to notify the server
      /*
      fetch(`${baseURL}/notifications/cancelled-return`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cartId, pisaCode })
      });
      */
    }

    // Notification functions
    function showNotification(type = 'success', title = '', message = '') {
      const notification = document.getElementById('appNotification');
      const iconMap = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      notification.className = 'notification';
      notification.classList.add(type);
      
      const icon = notification.querySelector('.notification-icon');
      icon.className = `fas ${iconMap[type]} notification-icon`;
      
      if (title) notification.querySelector('.notification-title').textContent = title;
      if (message) notification.querySelector('.notification-message').textContent = message;
      
      notification.classList.add('active');
      setTimeout(hideNotification, 5000);
    }

    function hideNotification() {
      document.getElementById('appNotification').classList.remove('active');
    }

    async function fetchBeautyTip() {
      try {
        const timestamp = new Date().getTime();
        const response = await fetch(`https://api.adviceslip.com/advice?t=${timestamp}`);
        
        if (!response.ok) throw new Error('Failed to fetch beauty tip');
        
        const data = await response.json();
        if (!data.slip?.advice) throw new Error('Invalid beauty tip format');
        
        return data.slip.advice;
      } catch (error) {
        console.error('Error fetching beauty tip:', error);
        const fallbackTips = [
          "Stay hydrated for glowing skin! Drink at least 8 glasses of water daily.",
          "Get enough sleep - your skin repairs itself while you rest.",
          "Always remove makeup before going to bed.",
          "Use sunscreen daily to protect your skin from UV damage.",
          "Exfoliate 2-3 times a week for smoother skin.",
          "Moisturize daily to maintain your skin's natural barrier.",
          "Eat a balanced diet rich in fruits and vegetables.",
          "Reduce stress through meditation or deep breathing exercises.",
          "Don't touch your face too often to prevent breakouts.",
          "Change your pillowcases regularly for cleaner skin."
        ];
        return fallbackTips[Math.floor(Math.random() * fallbackTips.length)];
      }
    }

    async function showBeautyTip() {
      const tipElement = document.getElementById('beautyTipContent');
      const beautyTip = document.getElementById('beautyTip');
      
      // Show loading state immediately
      tipElement.textContent = "Loading beauty tip...";
      beautyTip.classList.add('show');
      
      try {
        const tip = await fetchBeautyTip();
        // Update with actual tip when received
        tipElement.textContent = tip;
        setTimeout(() => beautyTip.classList.contains('show') && hideBeautyTip(), 8000);
      } catch (error) {
        tipElement.textContent = "Couldn't load a new tip. Try spinning again!";
        setTimeout(hideBeautyTip, 3000);
      }
    }

    function hideBeautyTip() {
      document.getElementById('beautyTip').classList.remove('show');
    }

    function setupCircularTracker(cartId, status) {
      const tracker = document.querySelector(`[data-cart="${cartId}"] .circular-tracker`);
      if (!tracker) return;

      const progress = getStatusProgress(status);
      tracker.style.background = `conic-gradient(var(--primary-color) ${progress}%, #e0e0e0 ${progress}%)`;
      
      // Clone to clear existing listeners
      const newTracker = tracker.cloneNode(true);
      tracker.replaceWith(newTracker);
      
      newTracker.addEventListener('mousedown', startSpin);
      newTracker.addEventListener('touchstart', startSpin, { passive: false });
      newTracker.dataset.cartId = cartId;
    }

    function startSpin(e) {
      if (isSpinning) return;
      e.preventDefault();
      isSpinning = true;
      activeTracker = e.currentTarget;
      activeTracker.style.transition = 'transform 0.05s linear';
      spinStartTime = performance.now();
      
      // Show loading notification immediately when spinning starts
      const tipElement = document.getElementById('beautyTipContent');
      tipElement.textContent = "Loading beauty tip...";
      document.getElementById('beautyTip').classList.add('show');
      
      // Start spinning animation
      cancelAnimationFrame(animationFrameId);
      animationFrameId = requestAnimationFrame(spin);
    }

    function spin(timestamp) {
      if (!activeTracker) return;
      
      const elapsed = timestamp - spinStartTime;
      const progress = Math.min(elapsed / SPIN_DURATION, 1);
      
      // Cubic ease-out function for smooth deceleration
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const rotation = easeOut * 1080; // Rotate 3 full circles (1080 degrees)
      
      activeTracker.style.transform = `rotate(${rotation}deg)`;
      
      if (progress < 1) {
        animationFrameId = requestAnimationFrame(spin);
      } else {
        finishSpin();
      }
    }

    function finishSpin() {
      if (!activeTracker) return;
      
      activeTracker.style.transition = 'transform 0.5s ease-out';
      activeTracker.style.transform = 'rotate(0deg)';
      
      // Fetch and show the actual beauty tip after spin completes
      fetchBeautyTip().then(tip => {
        document.getElementById('beautyTipContent').textContent = tip;
      }).catch(error => {
        document.getElementById('beautyTipContent').textContent = "Couldn't load a new tip. Try spinning again!";
      });
      
      // Reset tracker after animation completes
      setTimeout(() => {
        if (activeTracker) {
          activeTracker.style.transition = '';
        }
        isSpinning = false;
      }, 500);
    }

    function toIST(utcTime) {
      if (!utcTime) return 'Not available';
      const date = new Date(utcTime);
      date.setHours(date.getHours() + 5, date.getMinutes() + 30);
      return date.toLocaleString('en-IN', { 
        day: 'numeric',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }

    function getDeliveryDate(orderDate, status) {
      if (!orderDate) return 'Not available';
      const date = new Date(orderDate);
      date.setHours(date.getHours() + 5, date.getMinutes() + 30);
      
      // Always add 7 days to order date regardless of status
      date.setDate(date.getDate() + 7);
      
      // For delivered orders, just return "Delivered"
      if (status.toLowerCase().includes('delivered')) {
        return "Delivered";
      }
      
      return date.toLocaleString('en-IN', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
    }

    function getStatusProgress(status) {
      const statusMap = {
        'ordered': 1,
        'shipped': 36,
        'out for delivery': 67,
        'delivered': 100,
        'cancelled': 0,
        'requested for return': 0,
        'cancelled return': 0
      };
      return statusMap[status.toLowerCase()] || 0;
    }

    function getActiveStep(status) {
      const steps = ['ordered', 'shipped', 'out for delivery', 'delivered'];
      return steps.findIndex(step => status.toLowerCase().includes(step));
    }

    function formatCurrency(amount) {
      const num = parseFloat(amount.toString().replace(/[^\d.-]/g, ''));
      return '₹' + (isNaN(num) ? '0.00' : num.toFixed(2));
    }

    // Function to set delivery timestamp when order is delivered
    function setDeliveryTimestamp(cartId) {
      const now = new Date().toISOString();
      localStorage.setItem(`deliveryTime_${cartId}`, now);
      return now;
    }

    // Function to get delivery timestamp
    function getDeliveryTimestamp(cartId) {
      return localStorage.getItem(`deliveryTime_${cartId}`);
    }

    // Function to set return request timestamp
    function setReturnRequestTimestamp(cartId) {
      const now = new Date().getTime();
      localStorage.setItem(`returnRequestTime_${cartId}`, now);
      return now;
    }

    // Function to get return request timestamp
    function getReturnRequestTimestamp(cartId) {
      return localStorage.getItem(`returnRequestTime_${cartId}`);
    }

    // Function to check if return period has expired (12 hours from delivery)
    function isReturnPeriodExpired(deliveryTime) {
      if (!deliveryTime) return true;
      
      const deliveryDate = new Date(deliveryTime);
      const now = new Date();
      const diffMs = now - deliveryDate;
      
      return diffMs >= RETURN_PERIOD_MS;
    }

    // Function to check if cancel return period has expired (6 hours from return request)
    function isCancelReturnPeriodExpired(returnRequestTime) {
      if (!returnRequestTime) return true;
      
      const returnRequestDate = new Date(parseInt(returnRequestTime));
      const now = new Date();
      const diffMs = now - returnRequestDate;
      
      return diffMs >= CANCEL_RETURN_PERIOD_MS;
    }

    // Function to get remaining time for return
    function getRemainingReturnTime(deliveryTime) {
      if (!deliveryTime) return 0;
      
      const deliveryDate = new Date(deliveryTime);
      const now = new Date();
      const diffMs = now - deliveryDate;
      const remainingMs = RETURN_PERIOD_MS - diffMs;
      
      return Math.max(0, remainingMs);
    }

    // Function to get remaining time for cancel return
    function getRemainingCancelReturnTime(returnRequestTime) {
      if (!returnRequestTime) return 0;
      
      const returnRequestDate = new Date(parseInt(returnRequestTime));
      const now = new Date();
      const diffMs = now - returnRequestDate;
      const remainingMs = CANCEL_RETURN_PERIOD_MS - diffMs;
      
      return Math.max(0, remainingMs);
    }

    // Function to format time for display
    function formatTime(ms) {
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${seconds}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds}s`;
      } else {
        return `${seconds}s`;
      }
    }

    // Setup return button timer for delivered orders
    function setupReturnButtonTimer(cartId, status) {
      // Clear any existing timer for this cart
      if (returnTimers[cartId]) {
        clearInterval(returnTimers[cartId]);
        delete returnTimers[cartId];
      }

      // Only proceed for delivered orders
      if (!status.toLowerCase().includes('delivered')) return;

      const returnButton = document.querySelector(`[data-cart="${cartId}"] .return-btn`);
      const timerElement = document.querySelector(`[data-cart="${cartId}"] .return-timer`);
      
      if (!returnButton || !timerElement) return;

      // Get or set delivery timestamp
      let deliveryTime = getDeliveryTimestamp(cartId);
      if (!deliveryTime) {
        deliveryTime = setDeliveryTimestamp(cartId);
      }

      // Check if return period has expired
      if (isReturnPeriodExpired(deliveryTime)) {
        returnButton.disabled = true;
        returnButton.innerHTML = '<i class="fas fa-exchange-alt"></i> Return Period Expired';
        timerElement.textContent = "You can't return the order anymore";
        timerElement.classList.add('expired');
        return;
      }

      // Set up countdown timer
      const updateTimer = () => {
        const remainingMs = getRemainingReturnTime(deliveryTime);
        
        if (remainingMs <= 0) {
          // Time's up - disable the button
          returnButton.disabled = true;
          returnButton.innerHTML = '<i class="fas fa-exchange-alt"></i> Return Period Expired';
          timerElement.textContent = "You can't return the order anymore";
          timerElement.classList.add('expired');
          
          // Clear the interval
          clearInterval(returnTimers[cartId]);
          delete returnTimers[cartId];
        } else {
          // Update the timer display
          timerElement.textContent = `Return window closes in: ${formatTime(remainingMs)}`;
          timerElement.classList.remove('expired');
        }
      };

      // Initial update
      updateTimer();
      
      // Set interval to update every second
      returnTimers[cartId] = setInterval(updateTimer, 1000);
    }

    // Setup cancel return button timer for return requested orders
    function setupCancelReturnButtonTimer(cartId, status) {
      // Clear any existing timer for this cart
      if (returnTimers[`cancel_${cartId}`]) {
        clearInterval(returnTimers[`cancel_${cartId}`]);
        delete returnTimers[`cancel_${cartId}`];
      }

      // Only proceed for return requested orders
      if (!status.toLowerCase().includes('requested for return')) return;

      const cancelReturnButton = document.querySelector(`[data-cart="${cartId}"] .cancel-return-btn`);
      const timerElement = document.querySelector(`[data-cart="${cartId}"] .cancel-return-timer`);
      
      if (!cancelReturnButton || !timerElement) return;

      // Get or set return request timestamp
      let returnRequestTime = getReturnRequestTimestamp(cartId);
      if (!returnRequestTime) {
        returnRequestTime = setReturnRequestTimestamp(cartId);
      }

      // Check if cancel return period has expired
      if (isCancelReturnPeriodExpired(returnRequestTime)) {
        cancelReturnButton.disabled = true;
        cancelReturnButton.innerHTML = '<i class="fas fa-times-circle"></i> Cancel Return Expired';
        timerElement.textContent = "You can't cancel the return request anymore";
        timerElement.classList.add('expired');
        return;
      }

      // Set up countdown timer
      const updateTimer = () => {
        const remainingMs = getRemainingCancelReturnTime(returnRequestTime);
        
        if (remainingMs <= 0) {
          // Time's up - disable the button
          cancelReturnButton.disabled = true;
          cancelReturnButton.innerHTML = '<i class="fas fa-times-circle"></i> Cancel Return Expired';
          timerElement.textContent = "You can't cancel the return request anymore";
          timerElement.classList.add('expired');
          
          // Clear the interval
          clearInterval(returnTimers[`cancel_${cartId}`]);
          delete returnTimers[`cancel_${cartId}`];
        } else {
          // Update the timer display
          timerElement.textContent = `Cancel return window closes in: ${formatTime(remainingMs)}`;
          timerElement.classList.remove('expired');
        }
      };

      // Initial update
      updateTimer();
      
      // Set interval to update every second
      returnTimers[`cancel_${cartId}`] = setInterval(updateTimer, 1000);
    }

    async function updateOrderStatus(cartId, newStatus) {
      try {
        const response = await fetch(`${baseURL}/carts/update-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: cartId, new_status: newStatus })
        });

        if (response.ok) {
          showNotification('success', 'Success', `Order ${newStatus} successfully!`);
          
          if (newStatus.toLowerCase() === 'cancelled') {
            const cancelBtn = document.querySelector(`[data-cart="${cartId}"] .cancel-btn`);
            if (cancelBtn) {
              cancelBtn.disabled = true;
              cancelBtn.innerHTML = '<i class="fas fa-ban"></i> Order Cancelled';
            }
          }
          
          // If status is being set to delivered, set the delivery timestamp
          if (newStatus.toLowerCase().includes('delivered')) {
            setDeliveryTimestamp(cartId);
            // Set up the return button timer
            setupReturnButtonTimer(cartId, newStatus);
          }
          
          // If status is being set to requested for return, set the return request timestamp
          if (newStatus.toLowerCase().includes('requested for return')) {
            setReturnRequestTimestamp(cartId);
            // Set up the cancel return button timer
            setupCancelReturnButtonTimer(cartId, newStatus);
          }
          
          searchPisa();
        } else {
          const error = await response.json();
          showNotification('error', 'Error', error.message || 'Failed to update status');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'Error', 'Failed to update order status. Please try again.');
      }
    }

    async function searchPisa() {
      const pisaCode = document.getElementById('pisaInput').value.trim();
      if (!pisaCode) {
        showNotification('warning', 'Attention', 'Please enter a PISA Code');
        return;
      }

      // Save the PISACODE to localStorage
      savePisaCode(pisaCode);
      
      // Hide expiration message if shown
      document.getElementById('pisaExpiredMessage').style.display = 'none';

      const results = document.getElementById('results');
      results.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div><h3>Loading your orders...</h3></div>';

      try {
        // First, let's check if we have payment data in localStorage from the payment page
        let paymentData = JSON.parse(localStorage.getItem('paymentData') || '{}');
        
        // If we don't have payment data in localStorage, try to fetch from the server
        if (!paymentData || Object.keys(paymentData).length === 0) {
          try {
            const paymentsResponse = await fetch(`${baseURL}/payments`);
            if (paymentsResponse.ok) {
              const payments = await paymentsResponse.json();
              // Try to find payment for this PISA code
              paymentData = payments.find(p => p.pisa_code === pisaCode) || {};
            }
          } catch (e) {
            console.error("Error fetching payments:", e);
            paymentData = {};
          }
        }

        const [orders, carts] = await Promise.all([
          fetch(`${baseURL}/orders`).then(res => res.json()),
          fetch(`${baseURL}/carts`).then(res => res.json())
        ]);

        const userCarts = carts.filter(c => c.pisa_code == pisaCode);
        if (userCarts.length === 0) {
          results.innerHTML = `
            <div class="card">
              <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>No orders found</h3>
                <p>No data found for PISA Code: <strong>${pisaCode}</strong></p>
              </div>
            </div>
          `;
          return;
        }

        results.innerHTML = "";
        userCarts.sort((a, b) => new Date(b.processed_at || b.timestamp) - new Date(a.processed_at || a.timestamp));

        userCarts.forEach(cart => {
          const orderDate = cart.processed_at || cart.timestamp;
          const status = cart.status.toLowerCase();
          
          const isShipped = ['shipped', 'out for delivery', 'delivered'].some(s => status.includes(s));
          const isDelivered = status.includes('delivered');
          const isCancelled = status.includes('cancelled');
          const isReturnRequested = status.includes('requested for return');
          const isCancelledReturn = status.includes('cancelled return');
          
          // // Determine payment status - Check both the payment data from localStorage and cart data
          // let paymentMethod = 'COD';
          // let paymentStatusText = 'Pending';
          // let paymentStatusColor = 'var(--warning-color)';
          
          // // Check if we have payment data for this cart
          // if (paymentData && paymentData.cart_id === cart.id) {
          //   paymentMethod = paymentData.payment_method || 'COD';
            
          //   if (isDelivered) {
          //     paymentStatusText = 'Paid';
          //     paymentStatusColor = 'var(--success-color)';
          //   } else if (paymentMethod.toLowerCase() === 'prepaid') {
          //     paymentStatusText = 'Completed';
          //     paymentStatusColor = 'var(--success-color)';
          //   }
          // } else if (isDelivered) {
          //   // If delivered but no payment data, assume paid
          //   paymentStatusText = 'Paid';
          //   paymentStatusColor = 'var(--success-color)';
          // }
          // Determine payment status - Check both the payment data and cart data
let paymentMethod = cart.payment_method || 'COD';
let paymentStatusText = 'Pending';
let paymentStatusColor = 'var(--warning-color)';

// Check if we have payment data for this cart from server
if (paymentMethod.toLowerCase() === 'prepaid') {
  paymentStatusText = 'Completed';
  paymentStatusColor = 'var(--success-color)';
} else if (isDelivered) {
  // If delivered with COD, mark as paid
  paymentStatusText = 'Paid';
  paymentStatusColor = 'var(--success-color)';
}

// Check localStorage as fallback (for current session only)
const localPaymentData = JSON.parse(localStorage.getItem('paymentData') || '{}');
if (localPaymentData && localPaymentData.payment_method === 'prepaid') {
  paymentMethod = 'prepaid';
  paymentStatusText = 'Completed';
  paymentStatusColor = 'var(--success-color)';
}

          results.innerHTML += `
            <div class="card" data-cart="${cart.id}">
              <h3><i class="fas fa-shopping-cart"></i> Order #${cart.id.slice(0, 8)}</h3>
              
              <div class="delivery-date">
                <i class="fas fa-truck"></i>
                <span>${isDelivered ? 'Delivered' : 'Estimated Delivery:'} ${getDeliveryDate(orderDate, cart.status)}</span>
              </div>
              
              <div class="status-container">
                <div class="current-status">
                  <i class="fas fa-info-circle"></i>
                  <span>Current Status: ${cart.status.toUpperCase()}</span>
                </div>
                
                <div class="circular-tracker" style="background: conic-gradient(var(--primary-color) ${getStatusProgress(cart.status)}%, #e0e0e0 ${getStatusProgress(cart.status)}%)">
                  <div class="circular-tracker-inner">
                    <div class="circular-tracker-status">${cart.status.toUpperCase()}</div>
                    <div class="circular-tracker-hint">Spin me for a beauty tip!</div>
                  </div>
                </div>
                
                <div class="status-tracker">
                  <div class="status-progress-bar">
                    <div class="progress-fill" style="width: ${getStatusProgress(cart.status)}%"></div>
                  </div>
                  <div class="status-milestones">
                    ${['ordered', 'shipped', 'out for delivery', 'delivered'].map((step, index) => `
                      <div class="milestone ${getActiveStep(cart.status) >= index ? 'completed' : ''} ${getActiveStep(cart.status) === index ? 'active' : ''}">
                        <div class="milestone-marker">
                          ${getActiveStep(cart.status) > index ? '<i class="fas fa-check"></i>' : index + 1}
                        </div>
                        <span class="milestone-label">${step.charAt(0).toUpperCase() + step.slice(1)}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
              
              <div class="payment-grid">
                <div class="payment-item">
                  <span class="payment-label">Subtotal:</span>
                  <span class="payment-value">${formatCurrency(cart.subtotal)}</span>
                </div>
                <div class="payment-item">
                  <span class="payment-label">Payment Method:</span>
                  <span class="payment-value">${paymentMethod}</span>
                </div>
                <div class="payment-item">
                  <span class="payment-label">Payment Status:</span>
                  <span class="payment-value" style="color: ${paymentStatusColor}">
                    ${paymentStatusText}
                  </span>
                </div>
                <div class="payment-item" style="grid-column: span 2; border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 5px;">
                  <span class="payment-label total-amount">Total Amount:</span>
                  <span class="payment-value total-amount">${formatCurrency(cart.subtotal)}</span>
                </div>
              </div>
              
              <div class="action-buttons">
                <button class="action-btn cancel-btn" ${isShipped || isCancelled || isReturnRequested || isCancelledReturn ? 'disabled' : ''} onclick="${isCancelled ? '' : `showModal('${cart.id}')`}">
                  <i class="fas ${isCancelled ? 'fa-ban' : 'fa-times'}"></i> ${isCancelled ? 'Order Cancelled' : 'Cancel Order'}
                </button>
                <button class="action-btn return-btn" ${!isDelivered || isReturnRequested || isCancelledReturn ? 'disabled' : ''} onclick="updateOrderStatus('${cart.id}', 'requested for return')">
                  <i class="fas fa-exchange-alt"></i> Return Order
                </button>
                <button class="action-btn cancel-return-btn" ${!isReturnRequested ? 'disabled' : ''} onclick="showCancelReturnModal('${cart.id}')">
                  <i class="fas fa-times-circle"></i> Cancel Return Request
                </button>
              </div>
              
              ${isDelivered ? `
                <div class="return-timer" id="returnTimer-${cart.id}">
                  <i class="fas fa-clock"></i>
                  <span>Calculating return window...</span>
                </div>
              ` : ''}
              
              ${isReturnRequested ? `
                <div class="return-timer cancel-return-timer" id="cancelReturnTimer-${cart.id}">
                  <i class="fas fa-clock"></i>
                  <span>Calculating cancel return window...</span>
                </div>
              ` : ''}
              
              <div class="cashback-message" style="${isCancelledReturn ? 'display: block;' : 'display: none;'}">
                <p>You saved our return expenses😅! To get ₹10 cashback share your UPI phone number.</p>
                <button class="whatsapp-btn" onclick="openWhatsAppWithMessage('Hey, PisaKart! here is my UPI phone number:')">
                  <i class="fab fa-whatsapp"></i> Share UPI Number via WhatsApp
                </button>
              </div>
              
              <div class="product-container">
                ${cart.items.map(item => `
                  <div class="product-item">
                    <img class="product-img" src="${item.image || 'https://via.placeholder.com/80?text=Product'}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/80?text=Product'">
                    <p class="product-name">${item.name}</p>
                  </div>
                `).join("")}
              </div>
              
              <div class="timestamp">
                <i class="far fa-clock"></i>
                Order placed on: ${toIST(orderDate)}
              </div>
            </div>
          `;
        });

        userCarts.forEach(cart => {
          setupCircularTracker(cart.id, cart.status);
          if (cart.status.toLowerCase().includes('delivered')) {
            setupReturnButtonTimer(cart.id, cart.status);
          }
          if (cart.status.toLowerCase().includes('requested for return')) {
            setupCancelReturnButtonTimer(cart.id, cart.status);
          }
        });
      } catch (error) {
        results.innerHTML = `
          <div class="card">
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error loading data</h3>
              <p>There was an error fetching your order information. Please try again later.</p>
            </div>
          </div>
        `;
        console.error("Error fetching data:", error);
        showNotification('error', 'Error', 'Failed to load order data. Please try again.');
      }
    }

    document.getElementById('pisaInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') searchPisa();
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Check for expired PISACODE on page load
      loadSavedPisaCode();
      
      // Clear all return timers when page is unloading
      window.addEventListener('beforeunload', () => {
        for (const timerId in returnTimers) {
          clearInterval(returnTimers[timerId]);
        }
      });
    });
  </script>
</body>
</html>